{% extends '@CustomDatabase/sidebar/sidebar.html.twig' %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('bundles/customdatabase/static/database/style.css') }}">
{% endblock %}

{% block footscripts %}
    <script src="{{ asset('bundles/customdatabase/static/database/script.js') }}"></script>
{% endblock %}

{% block content %}

<div class="main-content">
    <div class="database-content">
    <div class="database-header">
        <div class="header-actions">
        </div>
        <h1><i class="fas fa-database"></i> Advanced Database Management System</h1>
        <p>Comprehensive database exploration, management, and analytics with advanced query capabilities</p>
    </div>

    {# Database Connections Section #}
    <div class="database-connections-section">
        <div class="connections-panel">
            <div class="dropdown-controls">
                <div class="control-group">
                    <label for="database-connections-dropdown">Select Database:</label>
                    <select id="database-connections-dropdown" class="form-control" onchange="onDatabaseSelectionChange()">
                        <option value="">Choose a database...</option>
                        {% for connection in connections %}
                        <option value="{{ connection.getId() }}" data-type="{{ connection.getDatabaseType() }}" data-host="{{ connection.getHost() }}" data-port="{{ connection.getPort() }}" data-status="{{ connection.getConnectionStatus() }}">
                            {{ connection.getConnectionName() }} ({{ connection.getDatabaseType()|upper }})
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="control-group">
                    <label for="database-tables-dropdown">Select Table:</label>
                    <select id="database-tables-dropdown" class="form-control" onchange="onTableSelectionChange()" disabled>
                        <option value="">Select a database first...</option>
                    </select>
                </div>
            </div>

            <div id="table-details" class="table-details-section" style="display: none;">
                <!-- Table details will be loaded here -->
            </div>
        </div>
    </div>

    {# Middle Section: Database Tables & Structure #}
    <div class="middle-section">
        <div class="database-tables-section">
            <h2><i class="fas fa-table"></i> Database Tables</h2>
            <div class="tables-management-panel">
                <div class="panel-tabs">
                    <button class="tab-btn active" data-tab="tables">Tables</button>
                    <button class="tab-btn" data-tab="structure">Structure</button>
                    <button class="tab-btn" data-tab="relationships">Relationships</button>
                    <button class="tab-btn" data-tab="indexes">Indexes</button>
                    <button class="tab-btn" data-tab="triggers">Triggers</button>
                    <button class="tab-btn" data-tab="views">Views</button>
                </div>

                <div class="tab-content">
                    <!-- Tables Tab -->
                    <div id="tables-tab" class="tab-pane active" style="display: block;">
                        <div class="tables-grid">
                            <div class="table-search-section">
                                <div class="search-controls">
                                    <div class="search-group">
                                        <i class="fas fa-search"></i>
                                        <input type="text" id="tableSearch" placeholder="Search tables..." class="search-input">
                                    </div>
                                    <div class="filter-controls">
                                        <select id="tableTypeFilter" class="filter-select">
                                            <option value="all">All Types</option>
                                            <option value="base">Base Tables</option>
                                            <option value="view">Views</option>
                                            <option value="system">System Tables</option>
                                        </select>
                                        <select id="sortBy" class="filter-select">
                                            <option value="name">Sort by Name</option>
                                            <option value="rows">Sort by Rows</option>
                                            <option value="size">Sort by Size</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="tables-list">
                                {% for table in tables %}
                                    {% set tableName = table|first %}
                                    <div class="table-card" data-table="{{ tableName }}">
                                        <div class="table-header">
                                            <div class="table-icon">
                                                <i class="fas fa-table"></i>
                                            </div>
                                            <div class="table-info">
                                                <h4>{{ tableName | replace({'_': ' '}) | capitalize }}</h4>
                                                <div class="table-meta">
                                                    <span class="table-rows"><i class="fas fa-list"></i> ~1,250 rows</span>
                                                    <span class="table-size"><i class="fas fa-hdd"></i> 45.2 MB</span>
                                                </div>
                                            </div>
                                            <div class="table-actions">
                                                <button class="btn btn-sm btn-outline-primary" onclick="viewTable('{{ tableName }}')">
                                                    <i class="fas fa-eye"></i> View
                                                </button>
                                                <button class="btn btn-sm btn-outline-secondary" onclick="editTable('{{ tableName }}')">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTable('{{ tableName }}')">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </div>
                                        </div>
                                        <div class="table-details" id="details-{{ tableName }}" style="display: none;">
                                            <div class="table-structure-preview">
                                                <h5>Structure Preview</h5>
                                                <div class="columns-list" id="columns-{{ tableName }}">
                                                    <!-- Columns will be loaded dynamically -->
                                                </div>
                                            </div>
                                            <div class="table-stats">
                                                <div class="stat-item">
                                                    <span class="stat-label">Engine:</span>
                                                    <span class="stat-value">InnoDB</span>
                                                </div>
                                                <div class="stat-item">
                                                    <span class="stat-label">Collation:</span>
                                                    <span class="stat-value">utf8mb4_unicode_ci</span>
                                                </div>
                                                <div class="stat-item">
                                                    <span class="stat-label">Created:</span>
                                                    <span class="stat-value">2024-01-15</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Structure Tab -->
                    <div id="structure-tab" class="tab-pane">
                        <div class="structure-viewer">
                            <div class="structure-controls">
                                <div class="control-group">
                                    <label for="selectedTable">Select Table:</label>
                                    <select id="selectedTable" class="form-control">
                                        <option value="">Choose a table...</option>
                                        {% for table in tables %}
                                            {% set tableName = table|first %}
                                            <option value="{{ tableName }}">{{ tableName | replace({'_': ' '}) | capitalize }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="control-actions">
                                    <button class="btn btn-primary" onclick="loadTableStructure()">
                                        <i class="fas fa-sync"></i> Load Structure
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="exportStructure()">
                                        <i class="fas fa-download"></i> Export
                                    </button>
                                </div>
                            </div>

                            <div id="structure-display" class="structure-display">
                                <div class="structure-placeholder">
                                    <i class="fas fa-database"></i>
                                    <h3>Select a table to view its structure</h3>
                                    <p>Choose a table from the dropdown above to see its columns, data types, and constraints.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Relationships Tab -->
                    <div id="relationships-tab" class="tab-pane">
                        <div class="relationships-viewer">
                            <div class="relationships-header">
                                <h3>Table Relationships</h3>
                                <p>Visual representation of foreign key relationships between tables</p>
                            </div>
                            <div class="relationships-canvas" id="relationshipsCanvas">
                                <div class="canvas-placeholder">
                                    <i class="fas fa-project-diagram"></i>
                                    <h4>Relationship Diagram</h4>
                                    <p>Interactive diagram showing table relationships will be displayed here.</p>
                                    <button class="btn btn-primary" onclick="generateRelationships()">
                                        <i class="fas fa-play"></i> Generate Diagram
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Indexes Tab -->
                    <div id="indexes-tab" class="tab-pane">
                        <div class="indexes-manager">
                            <div class="indexes-header">
                                <h3>Database Indexes</h3>
                                <p>Manage indexes for optimal query performance</p>
                            </div>
                            <div class="indexes-controls">
                                <button class="btn btn-primary" onclick="createIndex()">
                                    <i class="fas fa-plus"></i> Create Index
                                </button>
                                <button class="btn btn-outline-primary" onclick="analyzeIndexes()">
                                    <i class="fas fa-chart-bar"></i> Analyze Performance
                                </button>
                            </div>
                            <div class="indexes-list" id="indexesList">
                                <div class="index-placeholder">
                                    <i class="fas fa-search"></i>
                                    <h4>No indexes to display</h4>
                                    <p>Select a table to view its indexes or create a new one.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Triggers Tab -->
                    <div id="triggers-tab" class="tab-pane">
                        <div class="triggers-manager">
                            <div class="triggers-header">
                                <h3>Database Triggers</h3>
                                <p>Automated procedures that execute in response to database events</p>
                            </div>
                            <div class="triggers-controls">
                                <button class="btn btn-primary" onclick="createTrigger()">
                                    <i class="fas fa-plus"></i> Create Trigger
                                </button>
                                <button class="btn btn-outline-primary" onclick="viewTriggerLogs()">
                                    <i class="fas fa-history"></i> View Logs
                                </button>
                            </div>
                            <div class="triggers-list" id="triggersList">
                                <div class="trigger-placeholder">
                                    <i class="fas fa-bolt"></i>
                                    <h4>No triggers found</h4>
                                    <p>Create automated triggers to respond to database events.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Views Tab -->
                    <div id="views-tab" class="tab-pane">
                        <div class="views-manager">
                            <div class="views-header">
                                <h3>Database Views</h3>
                                <p>Virtual tables based on SQL SELECT queries</p>
                            </div>
                            <div class="views-controls">
                                <button class="btn btn-primary" onclick="createView()">
                                    <i class="fas fa-plus"></i> Create View
                                </button>
                                <button class="btn btn-outline-primary" onclick="refreshViews()">
                                    <i class="fas fa-sync"></i> Refresh
                                </button>
                            </div>
                            <div class="views-list" id="viewsList">
                                <div class="view-placeholder">
                                    <i class="fas fa-eye"></i>
                                    <h4>No views found</h4>
                                    <p>Create virtual tables to simplify complex queries.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Bottom Section: Query Builder & Data Explorer #}
    <div class="bottom-section">
        <div class="query-builder-section">
            <h2><i class="fas fa-code"></i> Advanced Query Builder & Data Explorer</h2>
            <div class="query-panel">
                <div class="panel-tabs">
                    <button class="tab-btn active" data-tab="query-builder">Query Builder</button>
                    <button class="tab-btn" data-tab="data-explorer">Data Explorer</button>
                    <button class="tab-btn" data-tab="analytics">Analytics</button>
                    <button class="tab-btn" data-tab="backup-restore">Backup & Restore</button>
                    <button class="tab-btn" data-tab="import-export">Import/Export</button>
                    <button class="tab-btn" data-tab="maintenance">Maintenance</button>
                </div>

                <div class="tab-content">
                    <!-- Query Builder Tab -->
                    <div id="query-builder-tab" class="tab-pane active" style="display: block;">
                        <div class="query-builder-interface">
                            <div class="query-controls">
                                <div class="control-row">
                                    <div class="control-group">
                                        <label for="queryTable">Table:</label>
                                        <select id="queryTable" class="form-control">
                                            <option value="">Select table...</option>
                                            {% for table in tables %}
                                                {% set tableName = table|first %}
                                                <option value="{{ tableName }}">{{ tableName | replace({'_': ' '}) | capitalize }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="control-group">
                                        <label for="queryType">Query Type:</label>
                                        <select id="queryType" class="form-control">
                                            <option value="SELECT">SELECT</option>
                                            <option value="INSERT">INSERT</option>
                                            <option value="UPDATE">UPDATE</option>
                                            <option value="DELETE">DELETE</option>
                                        </select>
                                    </div>
                                    <div class="control-actions">
                                        <button class="btn btn-primary" onclick="buildQuery()">
                                            <i class="fas fa-wrench"></i> Build Query
                                        </button>
                                        <button class="btn btn-success" onclick="executeQuery()">
                                            <i class="fas fa-play"></i> Execute
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="query-editor">
                                <div class="editor-header">
                                    <h4>SQL Query</h4>
                                    <div class="editor-actions">
                                        <button class="btn btn-sm btn-outline-secondary" onclick="formatQuery()">
                                            <i class="fas fa-magic"></i> Format
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="saveQuery()">
                                            <i class="fas fa-save"></i> Save
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="clearQuery()">
                                            <i class="fas fa-trash"></i> Clear
                                        </button>
                                    </div>
                                </div>
                                <textarea id="sqlQuery" class="sql-editor" placeholder="Enter your SQL query here..."></textarea>
                            </div>

                            <div class="query-results" id="queryResults" style="display: none;">
                                <div class="results-header">
                                    <h4>Query Results</h4>
                                    <div class="results-actions">
                                        <span id="executionTime"></span>
                                        <button class="btn btn-sm btn-outline-primary" onclick="exportResults()">
                                            <i class="fas fa-download"></i> Export
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="copyResults()">
                                            <i class="fas fa-copy"></i> Copy
                                        </button>
                                    </div>
                                </div>
                                <div class="results-table-container">
                                    <table class="results-table" id="resultsTable"></table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Data Explorer Tab -->
                    <div id="data-explorer-tab" class="tab-pane">
                        <div class="data-explorer-interface">
                            <div class="explorer-controls">
                                <div class="control-row">
                                    <div class="control-group">
                                        <label for="explorerTable">Table:</label>
                                        <select id="explorerTable" class="form-control">
                                            <option value="">Select table...</option>
                                            {% for table in tables %}
                                                {% set tableName = table|first %}
                                                <option value="{{ tableName }}">{{ tableName | replace({'_': ' '}) | capitalize }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="control-group">
                                        <label for="pageSize">Page Size:</label>
                                        <select id="pageSize" class="form-control">
                                            <option value="25">25 rows</option>
                                            <option value="50">50 rows</option>
                                            <option value="100">100 rows</option>
                                            <option value="200">200 rows</option>
                                        </select>
                                    </div>
                                    <div class="control-actions">
                                        <button class="btn btn-primary" onclick="loadTableData()">
                                            <i class="fas fa-table"></i> Load Data
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="addNewRecord()">
                                            <i class="fas fa-plus"></i> Add Record
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="data-table-container" id="dataTableContainer" style="display: none;">
                                <div class="table-toolbar">
                                    <div class="table-info">
                                        <span id="tableInfoText"></span>
                                    </div>
                                    <div class="table-pagination">
                                        <button class="btn btn-sm btn-outline-secondary" id="prevPage" disabled>
                                            <i class="fas fa-chevron-left"></i> Previous
                                        </button>
                                        <span id="pageInfo">Page 1 of 1</span>
                                        <button class="btn btn-sm btn-outline-secondary" id="nextPage" disabled>
                                            Next <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="data-table-wrapper">
                                    <table class="data-table" id="dataTable"></table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Tab -->
                    <div id="analytics-tab" class="tab-pane">
                        <div class="analytics-dashboard">
                            <div class="analytics-header">
                                <h3>Database Analytics</h3>
                                <p>Insights and performance metrics for your database</p>
                            </div>
                            <div class="analytics-grid">
                                <div class="analytics-card">
                                    <div class="card-header">
                                        <h4>Query Performance</h4>
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                    <div class="card-content">
                                        <div class="metric">
                                            <span class="metric-value">1.2s</span>
                                            <span class="metric-label">Avg Query Time</span>
                                        </div>
                                        <div class="metric">
                                            <span class="metric-value">98%</span>
                                            <span class="metric-label">Query Success Rate</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="analytics-card">
                                    <div class="card-header">
                                        <h4>Storage Usage</h4>
                                        <i class="fas fa-hdd"></i>
                                    </div>
                                    <div class="card-content">
                                        <div class="metric">
                                            <span class="metric-value">2.4 GB</span>
                                            <span class="metric-label">Total Size</span>
                                        </div>
                                        <div class="metric">
                                            <span class="metric-value">65%</span>
                                            <span class="metric-label">Usage</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="analytics-card">
                                    <div class="card-header">
                                        <h4>Active Connections</h4>
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <div class="card-content">
                                        <div class="metric">
                                            <span class="metric-value">12</span>
                                            <span class="metric-label">Current</span>
                                        </div>
                                        <div class="metric">
                                            <span class="metric-value">25</span>
                                            <span class="metric-label">Max</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="analytics-card">
                                    <div class="card-header">
                                        <h4>Table Growth</h4>
                                        <i class="fas fa-chart-bar"></i>
                                    </div>
                                    <div class="card-content">
                                        <div class="metric">
                                            <span class="metric-value">+15%</span>
                                            <span class="metric-label">This Month</span>
                                        </div>
                                        <div class="metric">
                                            <span class="metric-value">+8%</span>
                                            <span class="metric-label">This Week</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Backup & Restore Tab -->
                    <div id="backup-restore-tab" class="tab-pane">
                        <div class="backup-restore-interface">
                            <div class="backup-header">
                                <h3>Backup & Restore</h3>
                                <p>Create and manage database backups for data protection</p>
                            </div>
                            <div class="backup-controls">
                                <div class="backup-actions">
                                    <button class="btn btn-primary" onclick="createBackup()">
                                        <i class="fas fa-plus"></i> Create Backup
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="scheduleBackup()">
                                        <i class="fas fa-clock"></i> Schedule Backup
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="restoreBackup()">
                                        <i class="fas fa-undo"></i> Restore
                                    </button>
                                </div>
                            </div>
                            <div class="backup-list" id="backupList">
                                <div class="backup-item">
                                    <div class="backup-info">
                                        <h4>Full Backup - 2024-01-15</h4>
                                        <div class="backup-meta">
                                            <span><i class="fas fa-hdd"></i> 2.4 GB</span>
                                            <span><i class="fas fa-clock"></i> 15 minutes</span>
                                            <span><i class="fas fa-check-circle"></i> Completed</span>
                                        </div>
                                    </div>
                                    <div class="backup-actions">
                                        <button class="btn btn-sm btn-outline-primary" onclick="downloadBackup()">
                                            <i class="fas fa-download"></i> Download
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteBackup()">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Import/Export Tab -->
                    <div id="import-export-tab" class="tab-pane">
                        <div class="import-export-interface">
                            <div class="import-export-header">
                                <h3>Data Import & Export</h3>
                                <p>Import data from various formats or export your database</p>
                            </div>
                            <div class="import-export-grid">
                                <div class="import-section">
                                    <h4><i class="fas fa-file-import"></i> Import Data</h4>
                                    <div class="import-options">
                                        <div class="import-option" onclick="importFromCSV()">
                                            <i class="fas fa-file-csv"></i>
                                            <span>CSV Files</span>
                                        </div>
                                        <div class="import-option" onclick="importFromExcel()">
                                            <i class="fas fa-file-excel"></i>
                                            <span>Excel Files</span>
                                        </div>
                                        <div class="import-option" onclick="importFromJSON()">
                                            <i class="fas fa-file-code"></i>
                                            <span>JSON Files</span>
                                        </div>
                                        <div class="import-option" onclick="importFromSQL()">
                                            <i class="fas fa-database"></i>
                                            <span>SQL Files</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="export-section">
                                    <h4><i class="fas fa-file-export"></i> Export Data</h4>
                                    <div class="export-options">
                                        <div class="export-option" onclick="exportToCSV()">
                                            <i class="fas fa-file-csv"></i>
                                            <span>CSV</span>
                                        </div>
                                        <div class="export-option" onclick="exportToExcel()">
                                            <i class="fas fa-file-excel"></i>
                                            <span>Excel</span>
                                        </div>
                                        <div class="export-option" onclick="exportToJSON()">
                                            <i class="fas fa-file-code"></i>
                                            <span>JSON</span>
                                        </div>
                                        <div class="export-option" onclick="exportToSQL()">
                                            <i class="fas fa-database"></i>
                                            <span>SQL</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Maintenance Tab -->
                    <div id="maintenance-tab" class="tab-pane">
                        <div class="maintenance-interface">
                            <div class="maintenance-header">
                                <h3>Database Maintenance</h3>
                                <p>Optimize and maintain your database performance</p>
                            </div>
                            <div class="maintenance-grid">
                                <div class="maintenance-card">
                                    <div class="card-icon">
                                        <i class="fas fa-broom"></i>
                                    </div>
                                    <div class="card-content">
                                        <h4>Optimize Tables</h4>
                                        <p>Defragment and optimize table storage</p>
                                        <button class="btn btn-outline-primary" onclick="optimizeTables()">
                                            Optimize
                                        </button>
                                    </div>
                                </div>

                                <div class="maintenance-card">
                                    <div class="card-icon">
                                        <i class="fas fa-wrench"></i>
                                    </div>
                                    <div class="card-content">
                                        <h4>Repair Tables</h4>
                                        <p>Repair corrupted or damaged tables</p>
                                        <button class="btn btn-outline-primary" onclick="repairTables()">
                                            Repair
                                        </button>
                                    </div>
                                </div>

                                <div class="maintenance-card">
                                    <div class="card-icon">
                                        <i class="fas fa-search"></i>
                                    </div>
                                    <div class="card-content">
                                        <h4>Analyze Tables</h4>
                                        <p>Update table statistics for better performance</p>
                                        <button class="btn btn-outline-primary" onclick="analyzeTables()">
                                            Analyze
                                        </button>
                                    </div>
                                </div>

                                <div class="maintenance-card">
                                    <div class="card-icon">
                                        <i class="fas fa-trash-alt"></i>
                                    </div>
                                    <div class="card-content">
                                        <h4>Clean Up</h4>
                                        <p>Remove temporary files and old data</p>
                                        <button class="btn btn-outline-primary" onclick="cleanupDatabase()">
                                            Clean Up
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

{% endblock %}
